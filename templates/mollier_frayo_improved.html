<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagramme de Mollier Frayo - Maintenance Prédictive Frigorifique</title>
    
    <!-- Chart.js pour graphiques interactifs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Plotly.js pour diagrammes scientifiques avancés -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Animate.css pour animations -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-radius: 12px;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--secondary-color);
            line-height: 1.6;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border-bottom: 3px solid var(--primary-color);
        }

        .header h1 {
            color: var(--secondary-color);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            transition: var(--transition);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
        }

        .nav-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .diagram-section {
            text-align: center;
        }

        .diagram-section h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            box-shadow: var(--shadow);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, var(--primary-color));
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #229954);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #229954, var(--success-color));
            transform: translateY(-2px);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #138496);
            color: white;
        }

        .diagram-container {
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 2rem;
            background: var(--light-color);
            margin: 2rem 0;
            min-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .diagram-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 49%, rgba(255,255,255,0.1) 50%, transparent 51%);
            pointer-events: none;
        }

        .diagram-image {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .diagram-image:hover {
            transform: scale(1.02);
        }

        .interactive-diagram {
            width: 100%;
            height: 600px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            color: #666;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metadata-section {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .metadata-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: var(--transition);
        }

        .metadata-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .metadata-item h4 {
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metadata-item p {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .properties-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .properties-card {
            background: var(--light-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .properties-card:hover {
            transform: translateX(5px);
            border-left-width: 6px;
        }

        .properties-card h3 {
            color: var(--secondary-color);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .property-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: var(--transition);
        }

        .property-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
        }

        .property-label {
            font-weight: 600;
            color: #555;
        }

        .property-value {
            color: var(--secondary-color);
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .error-message, .success-message {
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            text-align: center;
            font-weight: 600;
            box-shadow: var(--shadow);
        }

        .error-message {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            color: white;
        }

        .success-message {
            background: linear-gradient(135deg, var(--success-color), #229954);
            color: white;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab:hover {
            color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-buttons, .controls {
                flex-direction: column;
            }
            
            .properties-section {
                grid-template-columns: 1fr;
            }
            
            .metadata-grid {
                grid-template-columns: 1fr;
            }
            
            .diagram-container {
                padding: 1rem;
                min-height: 400px;
            }
        }

        @media (max-width: 480px) {
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .card {
                padding: 1.5rem;
            }
        }

        /* Animations avancées */
        .animate-on-scroll {
            opacity: 0;
            transform: translateY(30px);
            transition: var(--transition);
        }

        .animate-on-scroll.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Style pour les tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Styles pour l'onglet complet */
        .complete-diagram-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(52, 58, 64, 0.1);
        }

        .feature-badges .badge {
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
        }

        .progress-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            border: 1px solid rgba(52, 58, 64, 0.1);
        }

        .diagram-placeholder {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px dashed #dee2e6;
            border-radius: var(--border-radius);
            padding: 3rem 2rem;
            text-align: center;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .placeholder-content {
            max-width: 500px;
        }

        .placeholder-content ul {
            margin-top: 1rem;
        }

        .placeholder-content li {
            margin-bottom: 0.5rem;
            padding-left: 1rem;
        }

        .complete-specifications {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border: 1px solid rgba(52, 58, 64, 0.1);
            box-shadow: var(--shadow);
        }

        .diagram-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            border: 1px solid rgba(52, 58, 64, 0.1);
            box-shadow: var(--shadow);
        }

        .complete-diagram-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .info-card {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .info-card i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .spec-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .spec-item h6 {
            margin-bottom: 0.75rem;
            color: var(--secondary-color);
        }

        @media (max-width: 768px) {
            .complete-diagram-header .controls {
                text-align: center !important;
                margin-top: 1rem;
            }
            
            .complete-diagram-header .controls .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header animate__animated animate__fadeInDown">
        <h1><i class="bi bi-snow"></i> Diagramme de Mollier - Fluide Frayo</h1>
        <p>Système de refroidissement avec réservoir - Maintenance prédictive avancée</p>
        <div class="nav-buttons">
            <a href="/" class="nav-btn"><i class="bi bi-house-fill"></i> Accueil</a>
            <a href="/dashboard" class="nav-btn"><i class="bi bi-graph-up"></i> Dashboard</a>
            <a href="/diagrams" class="nav-btn"><i class="bi bi-diagram-3"></i> Diagrammes</a>
            <a href="/predictions" class="nav-btn"><i class="bi bi-magic"></i> Prédictions</a>
            <a href="/alerts" class="nav-btn"><i class="bi bi-exclamation-triangle"></i> Alertes</a>
        </div>
    </div>

    <div class="container">
        <!-- Section Diagramme Principal -->
        <div class="card diagram-section animate-on-scroll">
            <h2><i class="bi bi-graph-up-arrow"></i> Diagramme de Mollier (h-s) pour Frayo</h2>
            <p>Diagramme enthalpie-entropie adapté aux données collectées depuis le réservoir</p>
            
            <!-- Onglets pour différents modes -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('static')">
                    <i class="bi bi-image"></i> Statique
                </button>
                <button class="tab" onclick="switchTab('interactive')">
                    <i class="bi bi-cursor"></i> Interactif
                </button>
                <button class="tab" onclick="switchTab('comparison')">
                    <i class="bi bi-layers"></i> Comparaison
                </button>
                <button class="tab" onclick="switchTab('complete')">
                    <i class="bi bi-diagram-3-fill"></i> Complet
                </button>
            </div>

            <!-- Contenu onglet statique -->
            <div id="staticTab" class="tab-content active">
                <div class="controls">
                    <button class="btn btn-primary" onclick="generateDiagram()">
                        <i class="bi bi-arrow-clockwise"></i> Diagramme Complet
                    </button>
                    <button class="btn btn-primary" onclick="generatePedagogicalDiagram()">
                        <i class="bi bi-book"></i> Version Pédagogique
                    </button>
                    <button class="btn btn-success" onclick="downloadDiagram()" id="downloadBtn" style="display: none;">
                        <i class="bi bi-download"></i> Télécharger PNG
                    </button>
                    <button class="btn btn-info" onclick="loadProperties()">
                        <i class="bi bi-list-ul"></i> Propriétés
                    </button>
                    <button class="btn btn-warning" onclick="showExplanation()">
                        <i class="bi bi-question-circle"></i> Explication
                    </button>
                </div>

                <div class="diagram-container" id="diagramContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Choisissez un type de diagramme pour commencer</p>
                    </div>
                </div>
            </div>

            <!-- Contenu onglet interactif -->
            <div id="interactiveTab" class="tab-content">
                <div class="controls">
                    <button class="btn btn-primary" onclick="generateInteractiveDiagram()">
                        <i class="bi bi-play-circle"></i> Créer Diagramme Interactif
                    </button>
                    <button class="btn btn-info" onclick="toggleAnimation()">
                        <i class="bi bi-play"></i> Animation
                    </button>
                </div>
                <div id="interactiveDiagram" class="interactive-diagram"></div>
            </div>

            <!-- Contenu onglet comparaison -->
            <div id="comparisonTab" class="tab-content">
                <div class="controls">
                    <button class="btn btn-primary" onclick="generateComparison()">
                        <i class="bi bi-layers"></i> Générer Comparaison
                    </button>
                </div>
                <div id="comparisonChart" class="interactive-diagram"></div>
            </div>

            <!-- Contenu onglet complet -->
            <div id="completeTab" class="tab-content">
                <div class="complete-diagram-header">
                    <div class="row">
                        <div class="col-md-8">
                            <h3><i class="bi bi-diagram-3-fill text-primary"></i> Diagramme Complet Responsive</h3>
                            <p class="text-muted mb-3">
                                Diagramme de Mollier (h-s) avec toutes les spécifications : zones colorées, 
                                cycle frigorifique, données producteur et encarts complémentaires.
                            </p>
                            <div class="feature-badges mb-3">
                                <span class="badge bg-success me-2">
                                    <i class="bi bi-check-circle"></i> 300 DPI
                                </span>
                                <span class="badge bg-info me-2">
                                    <i class="bi bi-palette"></i> Zones Colorées
                                </span>
                                <span class="badge bg-warning me-2">
                                    <i class="bi bi-arrow-repeat"></i> Cycle Frigorifique
                                </span>
                                <span class="badge bg-secondary">
                                    <i class="bi bi-graph-up"></i> Données Producteur
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="controls text-end">
                                <button class="btn btn-primary me-2" onclick="generateCompleteDiagram()">
                                    <i class="bi bi-play-circle"></i> Générer
                                </button>
                                <button class="btn btn-outline-secondary me-2" onclick="loadCompleteSpecifications()" disabled id="completeSpecsBtn">
                                    <i class="bi bi-info-circle"></i> Spécifications
                                </button>
                                <button class="btn btn-success" onclick="downloadCompleteDiagram()" disabled id="completeDownloadBtn">
                                    <i class="bi bi-download"></i> Télécharger
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barre de progression -->
                <div class="progress-container mb-4" id="completeProgressContainer" style="display: none;">
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" id="completeProgressBar"></div>
                    </div>
                    <small class="text-muted" id="completeProgressText">Initialisation...</small>
                </div>

                <!-- Zone d'affichage du diagramme complet -->
                <div class="diagram-container" id="completeDiagramContainer">
                    <div class="diagram-placeholder">
                        <div class="placeholder-content">
                            <i class="bi bi-diagram-3 text-primary" style="font-size: 4rem;"></i>
                            <h4 class="mt-3 text-muted">Diagramme Complet Prêt</h4>
                            <p class="text-muted">
                                Cliquez sur "Générer" pour créer le diagramme de Mollier complet avec :
                            </p>
                            <ul class="list-unstyled text-start">
                                <li><i class="bi bi-check text-success"></i> Zones colorées (rouge, bleu, violet)</li>
                                <li><i class="bi bi-check text-success"></i> Cycle frigorifique orange avec flèches</li>
                                <li><i class="bi bi-check text-success"></i> Données expérimentales du producteur</li>
                                <li><i class="bi bi-check text-success"></i> Encarts T-P et graphiques complémentaires</li>
                                <li><i class="bi bi-check text-success"></i> Légende claire et titre centré</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Spécifications détaillées -->
                <div class="complete-specifications mt-4" id="completeSpecifications" style="display: none;">
                    <h4><i class="bi bi-gear text-info"></i> Spécifications Techniques</h4>
                    <div id="completeSpecsContent"></div>
                </div>
            </div>
        </div>

        <!-- Section Métadonnées -->
        <div class="metadata-section animate-on-scroll" id="metadataSection" style="display: none;">
            <h3><i class="bi bi-info-circle"></i> Informations du Diagramme</h3>
            <div class="metadata-grid" id="metadataGrid">
                <!-- Contenu généré dynamiquement -->
            </div>
        </div>

        <!-- Section Propriétés -->
        <div class="properties-section animate-on-scroll" id="propertiesSection" style="display: none;">
            <div class="properties-card">
                <h3><i class="bi bi-snow"></i> Propriétés du Fluide Frayo</h3>
                <div id="fluidProperties">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>

            <div class="properties-card">
                <h3><i class="bi bi-graph-up"></i> Propriétés de Saturation</h3>
                <div id="saturationProperties">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>
        </div>

        <!-- Section Explication Pédagogique -->
        <div class="card animate-on-scroll" id="explanationSection" style="display: none;">
            <h2><i class="bi bi-book-half"></i> Explication Pédagogique du Diagramme de Mollier</h2>
            <div id="explanationContent">
                <!-- Contenu généré dynamiquement -->
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentDiagramData = null;
        let currentPropertiesData = null;
        let activeTab = 'static';
        let animationRunning = false;

        // Gestion des onglets
        function switchTab(tabName) {
            // Masquer tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Désactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activer l'onglet sélectionné
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            activeTab = tabName;
        }

        // Génération du diagramme complet (corrigée)
        async function generateDiagram() {
            await generateDiagramVersion('/api/mollier_frayo', 'Génération du diagramme complet en cours...');
        }

        // Génération du diagramme pédagogique (corrigée)
        async function generatePedagogicalDiagram() {
            await generateDiagramVersion('/api/mollier_pedagogique', 'Génération du diagramme pédagogique en cours...');
        }

        // Fonction générique de génération (corrigée)
        async function generateDiagramVersion(endpoint, loadingMessage) {
            const container = document.getElementById('diagramContainer');
            const downloadBtn = document.getElementById('downloadBtn');
            const metadataSection = document.getElementById('metadataSection');

            // Affichage du loading avec animation
            container.innerHTML = `
                <div class="loading animate__animated animate__pulse animate__infinite">
                    <div class="spinner"></div>
                    <p>${loadingMessage}</p>
                </div>
            `;

            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                if (data.status === 'success') {
                    currentDiagramData = data;
                    
                    // Affichage du diagramme avec animation
                    container.innerHTML = `
                        <img src="data:image/png;base64,${data.diagram_base64}" 
                             alt="Diagramme de Mollier Frayo" 
                             class="diagram-image animate__animated animate__zoomIn">
                    `;

                    // Affichage des métadonnées (CORRIGÉ)
                    displayMetadata(data.metadata);
                    metadataSection.style.display = 'block';
                    metadataSection.classList.add('animate__animated', 'animate__fadeInUp');
                    downloadBtn.style.display = 'inline-flex';

                    // Message de succès
                    const type = data.metadata.type || 'Diagramme';
                    showMessage(`✅ ${type} généré avec succès!`, 'success');

                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }

            } catch (error) {
                console.error('Erreur génération diagramme:', error);
                container.innerHTML = `
                    <div class="error-message animate__animated animate__shakeX">
                        <i class="bi bi-exclamation-triangle"></i> Erreur lors de la génération: ${error.message}
                    </div>
                `;
                showMessage(`❌ Erreur: ${error.message}`, 'error');
            }
        }

        // Chargement des propriétés
        async function loadProperties() {
            const propertiesSection = document.getElementById('propertiesSection');
            
            try {
                const response = await fetch('/api/frayo_properties');
                const data = await response.json();

                if (data.fluid_properties) {
                    currentPropertiesData = data;
                    displayFluidProperties(data.fluid_properties);
                    displaySaturationProperties(data.saturation_properties);
                    propertiesSection.style.display = 'grid';
                    propertiesSection.classList.add('animate__animated', 'animate__fadeInUp');
                    showMessage('✅ Propriétés chargées avec succès!', 'success');
                } else {
                    throw new Error('Données de propriétés invalides');
                }

            } catch (error) {
                console.error('Erreur chargement propriétés:', error);
                showMessage(`❌ Erreur propriétés: ${error.message}`, 'error');
            }
        }

        // Affichage des métadonnées (CORRIGÉ)
        function displayMetadata(metadata) {
            const grid = document.getElementById('metadataGrid');
            
            let html = '';
            
            // Métadonnées de base
            if (metadata.fluid_name || metadata.fluid) {
                html += `
                    <div class="metadata-item">
                        <h4><i class="bi bi-droplet"></i> Fluide</h4>
                        <p>${metadata.fluid_name || metadata.fluid}</p>
                    </div>
                `;
            }
            
            if (metadata.diagram_type || metadata.type) {
                html += `
                    <div class="metadata-item">
                        <h4><i class="bi bi-diagram-3"></i> Type</h4>
                        <p>${metadata.diagram_type || metadata.type}</p>
                    </div>
                `;
            }
            
            if (metadata.temperature_range) {
                html += `
                    <div class="metadata-item">
                        <h4><i class="bi bi-thermometer"></i> Températures</h4>
                        <p>${metadata.temperature_range}</p>
                    </div>
                `;
            }
            
            if (metadata.pressure_range) {
                html += `
                    <div class="metadata-item">
                        <h4><i class="bi bi-speedometer"></i> Pressions</h4>
                        <p>${metadata.pressure_range}</p>
                    </div>
                `;
            }

            // Zones colorées (CORRECTION pour l'erreur .map)
            if (metadata.zones) {
                let zonesHtml = '';
                
                if (Array.isArray(metadata.zones)) {
                    // Si c'est un tableau
                    zonesHtml = metadata.zones.map(zone => `<li>${zone}</li>`).join('');
                } else if (typeof metadata.zones === 'object') {
                    // Si c'est un objet
                    zonesHtml = Object.entries(metadata.zones).map(([key, value]) => 
                        `<li><strong>${key}:</strong> ${value}</li>`
                    ).join('');
                }
                
                if (zonesHtml) {
                    html += `
                        <div class="metadata-item" style="grid-column: span 2;">
                            <h4><i class="bi bi-palette"></i> Zones Colorées</h4>
                            <ul style="margin-top: 0.5rem; list-style-position: inside;">
                                ${zonesHtml}
                            </ul>
                        </div>
                    `;
                }
            }

            // Fonctionnalités
            if (metadata.features || metadata.elements_pedagogiques) {
                const features = metadata.features || metadata.elements_pedagogiques;
                if (Array.isArray(features)) {
                    const featuresHtml = features.map(feature => `<li>${feature}</li>`).join('');
                    html += `
                        <div class="metadata-item" style="grid-column: span 2;">
                            <h4><i class="bi bi-gear"></i> Fonctionnalités</h4>
                            <ul style="margin-top: 0.5rem; list-style-position: inside;">
                                ${featuresHtml}
                            </ul>
                        </div>
                    `;
                }
            }
            
            grid.innerHTML = html;
        }

        // Génération du diagramme interactif avec Plotly.js
        async function generateInteractiveDiagram() {
            const container = document.getElementById('interactiveDiagram');
            
            try {
                // Données pour le diagramme interactif
                const response = await fetch('/api/frayo_properties');
                const data = await response.json();
                
                if (data.saturation_properties) {
                    const satProps = data.saturation_properties;
                    
                    // Extraction des données
                    const temperatures = satProps.map(p => p.temperature_celsius);
                    const enthalpy_liquid = satProps.map(p => p.enthalpy_liquid_kj_kg);
                    const enthalpy_vapor = satProps.map(p => p.enthalpy_vapor_kj_kg);
                    const entropy_liquid = satProps.map(p => p.entropy_liquid_kj_kg_k);
                    const entropy_vapor = satProps.map(p => p.entropy_vapor_kj_kg_k);

                    // Configuration du graphique Plotly
                    const traces = [
                        {
                            x: entropy_liquid,
                            y: enthalpy_liquid,
                            mode: 'lines+markers',
                            name: 'Courbe de bulle (liquide saturé)',
                            line: { color: '#CC0000', width: 3 },
                            marker: { size: 8, color: '#CC0000' }
                        },
                        {
                            x: entropy_vapor,
                            y: enthalpy_vapor,
                            mode: 'lines+markers',
                            name: 'Courbe de rosée (vapeur saturée)',
                            line: { color: '#0066CC', width: 3 },
                            marker: { size: 8, color: '#0066CC' }
                        }
                    ];

                    const layout = {
                        title: {
                            text: 'Diagramme de Mollier Interactif - Fluide Frayo',
                            font: { size: 18, family: 'Inter' }
                        },
                        xaxis: {
                            title: 'Entropie spécifique s [kJ/kg·K]',
                            gridcolor: '#e0e0e0',
                            titlefont: { size: 14 }
                        },
                        yaxis: {
                            title: 'Enthalpie spécifique h [kJ/kg]',
                            gridcolor: '#e0e0e0',
                            titlefont: { size: 14 }
                        },
                        plot_bgcolor: 'white',
                        paper_bgcolor: 'white',
                        font: { family: 'Inter' },
                        hovermode: 'closest',
                        showlegend: true,
                        legend: {
                            x: 0.02,
                            y: 0.98,
                            bgcolor: 'rgba(255,255,255,0.8)',
                            bordercolor: '#e0e0e0',
                            borderwidth: 1
                        }
                    };

                    const config = {
                        responsive: true,
                        displayModeBar: true,
                        modeBarButtonsToAdd: ['select2d', 'lasso2d'],
                        displaylogo: false
                    };

                    Plotly.newPlot(container, traces, layout, config);
                    showMessage('✅ Diagramme interactif créé!', 'success');
                }
            } catch (error) {
                console.error('Erreur diagramme interactif:', error);
                container.innerHTML = `
                    <div class="error-message">
                        <i class="bi bi-exclamation-triangle"></i> Erreur création diagramme interactif: ${error.message}
                    </div>
                `;
            }
        }

        // Génération de la comparaison avec Chart.js
        async function generateComparison() {
            const container = document.getElementById('comparisonChart');
            
            try {
                // Créer un canvas pour Chart.js
                container.innerHTML = '<canvas id="comparisonCanvas"></canvas>';
                const ctx = document.getElementById('comparisonCanvas').getContext('2d');
                
                // Données simulées pour comparaison
                const labels = ['T=-10°C', 'T=0°C', 'T=10°C', 'T=20°C', 'T=30°C', 'T=40°C'];
                
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Enthalpie Liquide Saturé',
                                data: [200, 220, 240, 260, 280, 300],
                                borderColor: '#CC0000',
                                backgroundColor: 'rgba(204, 0, 0, 0.1)',
                                borderWidth: 3,
                                fill: true
                            },
                            {
                                label: 'Enthalpie Vapeur Saturée',
                                data: [310, 330, 350, 370, 390, 410],
                                borderColor: '#0066CC',
                                backgroundColor: 'rgba(0, 102, 204, 0.1)',
                                borderWidth: 3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Comparaison Propriétés de Saturation - Frayo',
                                font: { size: 16 }
                            },
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Enthalpie [kJ/kg]'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Température'
                                }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeInOutQuart'
                        }
                    }
                });
                
                showMessage('✅ Graphique de comparaison créé!', 'success');
                
            } catch (error) {
                console.error('Erreur comparaison:', error);
                container.innerHTML = `
                    <div class="error-message">
                        <i class="bi bi-exclamation-triangle"></i> Erreur création comparaison: ${error.message}
                    </div>
                `;
            }
        }

        // Animation toggle
        function toggleAnimation() {
            animationRunning = !animationRunning;
            const btn = event.target;
            
            if (animationRunning) {
                btn.innerHTML = '<i class="bi bi-pause"></i> Pause';
                btn.classList.remove('btn-info');
                btn.classList.add('btn-warning');
                
                // Démarrer animation cyclique
                startDiagramAnimation();
            } else {
                btn.innerHTML = '<i class="bi bi-play"></i> Animation';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-info');
            }
        }

        function startDiagramAnimation() {
            if (!animationRunning) return;
            
            // Animation cyclique entre les diagrammes
            setTimeout(() => {
                if (animationRunning) {
                    generatePedagogicalDiagram();
                    setTimeout(() => {
                        if (animationRunning) {
                            generateDiagram();
                            startDiagramAnimation();
                        }
                    }, 3000);
                }
            }, 3000);
        }

        // Affichage de l'explication pédagogique (inchangé mais amélioré visuellement)
        async function showExplanation() {
            const explanationSection = document.getElementById('explanationSection');
            const explanationContent = document.getElementById('explanationContent');

            try {
                const response = await fetch('/api/mollier_explanation');
                const data = await response.json();

                if (data.titre) {
                    let html = `
                        <div style="margin-bottom: 2rem;" class="animate__animated animate__fadeIn">
                            <h3><i class="bi bi-lightbulb"></i> ${data.titre}</h3>
                            <p style="font-size: 1.1rem; margin: 1rem 0; line-height: 1.8;">${data.description}</p>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div class="animate__animated animate__fadeInLeft">
                                <h4><i class="bi bi-graph-up-arrow"></i> Axes du diagramme</h4>
                                <div style="background: var(--light-color); padding: 1.5rem; border-radius: var(--border-radius); margin-top: 0.5rem; border-left: 4px solid var(--primary-color);">
                                    <p><strong>Axe X:</strong> ${data.axes.x}</p>
                                    <p><strong>Axe Y:</strong> ${data.axes.y}</p>
                                </div>
                            </div>
                            <div class="animate__animated animate__fadeInRight">
                                <h4><i class="bi bi-target"></i> Applications</h4>
                                <ul style="background: var(--light-color); padding: 1.5rem; border-radius: var(--border-radius); margin-top: 0.5rem; border-left: 4px solid var(--success-color);">
                    `;

                    data.applications.forEach(app => {
                        html += `<li style="margin-bottom: 0.5rem;"><i class="bi bi-check-circle text-success"></i> ${app}</li>`;
                    });

                    html += `
                                </ul>
                            </div>
                        </div>

                        <div class="animate__animated animate__fadeInUp">
                            <h4><i class="bi bi-palette"></i> Zones du diagramme</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
                    `;

                    Object.entries(data.zones_explication).forEach(([zone, info]) => {
                        const iconColor = zone === 'liquide' ? '#CC0000' : zone === 'vapeur' ? '#0066CC' : 'purple';
                        html += `
                            <div style="border: 2px solid ${iconColor}; border-radius: var(--border-radius); padding: 1.5rem; background: white; transition: var(--transition);" 
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='var(--shadow)'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <h5 style="color: ${iconColor}; margin-bottom: 1rem; font-size: 1.1rem;">
                                    <i class="bi bi-droplet-fill"></i> ${info.etat}
                                </h5>
                                <p><strong>Position:</strong> ${info.position}</p>
                                <p><strong>Couleur:</strong> ${info.couleur}</p>
                                <p style="margin-top: 1rem; font-style: italic; color: #666;">${info.description}</p>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>

                        <div style="margin-top: 2rem; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; padding: 2rem; border-radius: var(--border-radius);" class="animate__animated animate__fadeIn">
                            <h4><i class="bi bi-graph-up"></i> Courbes importantes</h4>
                            <div style="margin-top: 1.5rem; display: grid; gap: 1rem;">
                                <p><i class="bi bi-arrow-up-circle"></i> <strong>Courbe de bulle:</strong> ${data.courbes_importantes.courbe_bulle}</p>
                                <p><i class="bi bi-arrow-down-circle"></i> <strong>Courbe de rosée:</strong> ${data.courbes_importantes.courbe_rosee}</p>
                                <p><i class="bi bi-bullseye"></i> <strong>Point critique:</strong> ${data.courbes_importantes.point_critique}</p>
                            </div>
                        </div>
                    `;

                    explanationContent.innerHTML = html;
                    explanationSection.style.display = 'block';
                    explanationSection.classList.add('animate__animated', 'animate__fadeInUp');
                    
                    // Scroll vers l'explication
                    explanationSection.scrollIntoView({ behavior: 'smooth' });
                    
                    showMessage('📖 Explication chargée avec succès!', 'success');
                } else {
                    throw new Error('Données d\'explication invalides');
                }

            } catch (error) {
                console.error('Erreur chargement explication:', error);
                showMessage(`❌ Erreur explication: ${error.message}`, 'error');
            }
        }

        // Affichage des propriétés du fluide (amélioré)
        function displayFluidProperties(properties) {
            const container = document.getElementById('fluidProperties');
            
            const props = [
                { label: 'Nom', value: properties.name, icon: 'droplet' },
                { label: 'Température critique', value: `${properties.critical_temperature_celsius}°C`, icon: 'thermometer' },
                { label: 'Pression critique', value: `${properties.critical_pressure_bar} bar`, icon: 'speedometer' },
                { label: 'Masse molaire', value: `${properties.molar_mass_g_mol} g/mol`, icon: 'calculator' },
                { label: 'Constante des gaz', value: `${properties.gas_constant_kj_kg_k} kJ/kg·K`, icon: 'graph-up' }
            ];

            let html = '';
            props.forEach(prop => {
                html += `
                    <div class="property-item tooltip" data-tooltip="Propriété thermodynamique fondamentale">
                        <span class="property-label">
                            <i class="bi bi-${prop.icon}"></i> ${prop.label}:
                        </span>
                        <span class="property-value">${prop.value}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Affichage des propriétés de saturation (amélioré)
        function displaySaturationProperties(properties) {
            const container = document.getElementById('saturationProperties');
            
            let html = '<div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">';
            
            properties.forEach((prop, index) => {
                html += `
                    <div class="property-item animate__animated animate__fadeInUp" style="flex-direction: column; align-items: flex-start; margin-bottom: 1rem; animation-delay: ${index * 0.1}s;">
                        <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 0.5rem;">
                            <strong style="color: var(--primary-color); font-size: 1.1rem;">
                                <i class="bi bi-thermometer-half"></i> T = ${prop.temperature_celsius}°C
                            </strong>
                            <span class="tooltip" data-tooltip="Pression de saturation">
                                <i class="bi bi-speedometer"></i> ${prop.saturation_pressure_bar} bar
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%; font-size: 0.9rem; color: #666;">
                            <span><i class="bi bi-droplet"></i> h_liq = ${prop.enthalpy_liquid_kj_kg} kJ/kg</span>
                            <span><i class="bi bi-cloud"></i> h_vap = ${prop.enthalpy_vapor_kj_kg} kJ/kg</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Téléchargement du diagramme (amélioré)
        function downloadDiagram() {
            if (!currentDiagramData) {
                showMessage('❌ Aucun diagramme à télécharger', 'error');
                return;
            }

            const link = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 10);
            const type = currentDiagramData.metadata.type || 'mollier';
            link.href = `data:image/png;base64,${currentDiagramData.diagram_base64}`;
            link.download = `${type.toLowerCase().replace(/\s+/g, '_')}_frayo_${timestamp}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('💾 Diagramme téléchargé avec succès!', 'success');
        }

        // Affichage des messages (amélioré)
        function showMessage(message, type) {
            // Suppression des anciens messages
            const oldMessages = document.querySelectorAll('.success-message, .error-message');
            oldMessages.forEach(msg => msg.remove());

            // Création du nouveau message
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type === 'success' ? 'success-message' : 'error-message'} animate__animated animate__bounceIn`;
            messageDiv.innerHTML = message;

            // Insertion après les contrôles de l'onglet actif
            const activeTabContent = document.querySelector('.tab-content.active');
            const controls = activeTabContent.querySelector('.controls');
            if (controls) {
                controls.parentNode.insertBefore(messageDiv, controls.nextSibling);
            }

            // Suppression automatique après 5 secondes
            setTimeout(() => {
                messageDiv.classList.add('animate__fadeOut');
                setTimeout(() => messageDiv.remove(), 500);
            }, 5000);
        }

        // Animation des éléments au scroll
        function observeElements() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            });

            document.querySelectorAll('.animate-on-scroll').forEach((el) => {
                observer.observe(el);
            });
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🧊 Page Diagramme Mollier Frayo chargée avec améliorations');
            
            // Initialisation des animations
            observeElements();
            
            // Message d'accueil
            setTimeout(() => {
                showMessage('👋 Interface améliorée! Explorez les onglets pour différents modes de visualisation', 'success');
            }, 1000);
            
            // Préchargement des propriétés
            loadProperties();
        });

        // Gestion du redimensionnement
        window.addEventListener('resize', function() {
            // Redessiner les graphiques si nécessaire
            if (document.getElementById('interactiveDiagram').hasChildNodes()) {
                Plotly.Plots.resize('interactiveDiagram');
            }
        });

        // Variables globales pour l'onglet complet
        let currentCompleteDiagramData = null;

        // Génération du diagramme complet
        async function generateCompleteDiagram() {
            const container = document.getElementById('completeDiagramContainer');
            const progressContainer = document.getElementById('completeProgressContainer');
            const progressBar = document.getElementById('completeProgressBar');
            const progressText = document.getElementById('completeProgressText');
            const downloadBtn = document.getElementById('completeDownloadBtn');
            const specsBtn = document.getElementById('completeSpecsBtn');

            // Affichage du loading avec progression
            progressContainer.style.display = 'block';
            container.innerHTML = `
                <div class="diagram-placeholder">
                    <div class="placeholder-content">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <h4 class="text-primary">Génération en cours...</h4>
                        <p class="text-muted">Création du diagramme de Mollier complet avec données producteur</p>
                    </div>
                </div>
            `;

            // Simulation progression
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 12;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
                
                if (progress < 25) {
                    progressText.textContent = 'Initialisation des propriétés thermodynamiques...';
                } else if (progress < 50) {
                    progressText.textContent = 'Tracé des courbes de saturation et zones colorées...';
                } else if (progress < 75) {
                    progressText.textContent = 'Ajout du cycle frigorifique et données producteur...';
                } else {
                    progressText.textContent = 'Finalisation et optimisation haute résolution...';
                }
            }, 200);

            try {
                const response = await fetch('/api/mollier_complet');
                const data = await response.json();

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = 'Terminé !';

                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 1500);

                if (data.status === 'success') {
                    currentCompleteDiagramData = data;
                    
                    // Affichage du diagramme avec animation
                    container.innerHTML = `
                        <div class="text-center">
                            <img src="data:image/png;base64,${data.diagram_base64}" 
                                 alt="Diagramme de Mollier Complet Frayo" 
                                 class="complete-diagram-image animate__animated animate__fadeIn">
                            <div class="mt-3">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="info-card">
                                            <i class="bi bi-check-circle text-success"></i>
                                            <strong>Statut</strong><br>
                                            <span class="text-success">Généré avec succès</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="info-card">
                                            <i class="bi bi-file-earmark-image text-info"></i>
                                            <strong>Taille</strong><br>
                                            <span class="text-info">${Math.round(data.file_info.size_bytes / 1024)} KB</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="info-card">
                                            <i class="bi bi-camera text-warning"></i>
                                            <strong>Résolution</strong><br>
                                            <span class="text-warning">${data.file_info.resolution}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-primary me-2">
                                        <i class="bi bi-gear"></i> ${data.metadata.generation_info.features_count} fonctionnalités
                                    </span>
                                    <span class="badge bg-success me-2">
                                        <i class="bi bi-palette"></i> ${data.metadata.generation_info.zones_count} zones colorées
                                    </span>
                                    <span class="badge bg-warning">
                                        <i class="bi bi-arrow-repeat"></i> ${data.metadata.generation_info.cycle_points} points cycle
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;

                    // Activation des boutons
                    downloadBtn.disabled = false;
                    specsBtn.disabled = false;

                    // Message de succès
                    showMessage('✅ Diagramme complet généré avec toutes les spécifications!', 'success');

                } else {
                    container.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Erreur de génération :</strong> ${data.message}
                        </div>
                    `;
                    showMessage('❌ Erreur lors de la génération du diagramme complet', 'error');
                }

            } catch (error) {
                clearInterval(progressInterval);
                progressContainer.style.display = 'none';
                
                container.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-wifi-off"></i>
                        <strong>Erreur de connexion :</strong> ${error.message}
                    </div>
                `;
                showMessage('❌ Erreur de connexion API', 'error');
            }
        }

        // Chargement des spécifications complètes
        async function loadCompleteSpecifications() {
            if (!currentCompleteDiagramData) return;

            const specsSection = document.getElementById('completeSpecifications');
            const specsContent = document.getElementById('completeSpecsContent');

            try {
                const response = await fetch('/api/mollier_specifications');
                const data = await response.json();

                if (data.status === 'success') {
                    const specs = data.specifications;
                    
                    specsContent.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <div class="spec-item">
                                    <h6><i class="bi bi-rulers text-primary"></i> Axes du Diagramme</h6>
                                    <p><strong>X :</strong> ${specs.axes.x_axis.label}</p>
                                    <p><strong>Y :</strong> ${specs.axes.y_axis.label}</p>
                                </div>
                                
                                <div class="spec-item">
                                    <h6><i class="bi bi-palette text-success"></i> Zones Colorées</h6>
                                    <p><span style="background: ${specs.zones.liquid_subcooled.color}; padding: 2px 8px; border-radius: 3px; margin-right: 8px;"></span>Liquide sous-refroidi</p>
                                    <p><span style="background: ${specs.zones.vapor_superheated.color}; padding: 2px 8px; border-radius: 3px; margin-right: 8px;"></span>Vapeur surchauffée</p>
                                    <p><span style="background: ${specs.zones.mixture.color}; padding: 2px 8px; border-radius: 3px; margin-right: 8px;"></span>Mélange biphasique</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="spec-item">
                                    <h6><i class="bi bi-arrow-repeat text-warning"></i> Cycle Frigorifique</h6>
                                    <p><strong>Couleur :</strong> <span style="background: ${specs.refrigeration_cycle.color}; color: white; padding: 2px 8px; border-radius: 3px;">Orange</span></p>
                                    <ul>
                                        ${Object.entries(specs.refrigeration_cycle.points).map(([num, desc]) => 
                                            `<li><strong>Point ${num} :</strong> ${desc}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                                
                                <div class="spec-item">
                                    <h6><i class="bi bi-eye text-info"></i> Qualité et Style</h6>
                                    <p><strong>Résolution :</strong> 300 DPI haute qualité</p>
                                    <p><strong>Design :</strong> Responsive et scientifique</p>
                                    <p><strong>Éléments :</strong> ${currentCompleteDiagramData.metadata.generation_info.features_count} fonctionnalités</p>
                                </div>
                            </div>
                        </div>
                    `;

                    specsSection.style.display = 'block';
                    specsSection.scrollIntoView({ behavior: 'smooth' });
                    showMessage('📊 Spécifications chargées', 'info');
                }

            } catch (error) {
                specsContent.innerHTML = `
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        Erreur lors du chargement des spécifications : ${error.message}
                    </div>
                `;
                specsSection.style.display = 'block';
            }
        }

        // Téléchargement du diagramme complet
        function downloadCompleteDiagram() {
            if (!currentCompleteDiagramData) return;

            const link = document.createElement('a');
            link.href = 'data:image/png;base64,' + currentCompleteDiagramData.diagram_base64;
            link.download = 'mollier_frayo_complet_' + new Date().toISOString().slice(0,10) + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage('📥 Diagramme complet téléchargé!', 'success');
        }
    </script>
</body>
</html>
